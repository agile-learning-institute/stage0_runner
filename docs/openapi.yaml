openapi: 3.0.3
info:
  title: Stage0 Runbook API
  description: |
    REST API for executing, validating, and managing runbooks.
    Runbooks are markdown files that describe automated tasks with executable scripts.
    
    ## Environment Variables
    Environment variables required by runbooks should be passed in the request body as JSON.
    For example, to execute a runbook that requires `TEST_VAR`, use:
    ```
    POST /api/runbooks/SimpleRunbook.md/execute
    Authorization: Bearer YOUR_TOKEN
    Content-Type: application/json
    {
      "env_vars": {
        "TEST_VAR": "test_value"
      }
    }
    ```
  version: 0.1.0
  contact:
    name: Agile Learning Institute
  license:
    name: MIT

servers:
  - url: http://localhost:8083
    description: Local development server
  - url: http://localhost:8080
    description: Local development server (custom port)

tags:
  - name: Runbooks
    description: Runbook operations (execute, validate, retrieve)
  - name: Config
    description: Configuration operations (get current configuration)

paths:
  /api/runbooks:
    get:
      tags:
        - Runbooks
      summary: List all runbooks
      description: Retrieve a list of all available runbooks in the runbooks directory
      operationId: listRunbooks
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of runbooks retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunbookList'
        '401':
          description: Unauthorized - missing or invalid authentication token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-code-samples:
        - lang: curl
          source: |
            curl -X GET "http://localhost:8083/api/runbooks" \
              -H "Authorization: Bearer YOUR_TOKEN"

  /api/runbooks/{runbook}:
    get:
      tags:
        - Runbooks
      summary: Get runbook content
      description: |
        Retrieve the markdown content of a runbook file.
        This is a read-only operation that returns the full runbook including execution history.
      operationId: getRunbook
      security:
        - bearerAuth: []
      parameters:
        - name: runbook
          in: path
          required: true
          description: The runbook filename (e.g., SimpleRunbook.md)
          schema:
            type: string
            example: SimpleRunbook.md
      responses:
        '200':
          description: Runbook retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunbookContent'
        '401':
          description: Unauthorized - missing or invalid authentication token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Runbook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-code-samples:
        - lang: curl
          source: |
            curl -X GET "http://localhost:8083/api/runbooks/SimpleRunbook.md" \
              -H "Authorization: Bearer YOUR_TOKEN"

  /api/runbooks/{runbook}/validate:
    patch:
      tags:
        - Runbooks
      summary: Validate a runbook
      description: |
        Validate a runbook without executing it. Checks that:
        - The runbook file exists
        - Required sections are present
        - Environment variables are set
        - File system requirements are met
        
        Environment variables can be passed in the request body as JSON for validation.
      operationId: validateRunbook
      security:
        - bearerAuth: []
      parameters:
        - name: runbook
          in: path
          required: true
          description: The runbook filename (e.g., SimpleRunbook.md)
          schema:
            type: string
            example: SimpleRunbook.md
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateRequest'
            example:
              env_vars:
                TEST_VAR: test_value
      responses:
        '200':
          description: Runbook is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateResponse'
        '400':
          description: Validation failed - runbook has errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateResponse'
        '401':
          description: Unauthorized - missing or invalid authentication token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - insufficient permissions (RBAC check failed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Runbook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error during validation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-code-samples:
        - lang: curl
          source: |
            curl -X PATCH "http://localhost:8083/api/runbooks/SimpleRunbook.md/validate" \
              -H "Authorization: Bearer YOUR_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"env_vars":{"TEST_VAR":"test_value"}}'

  /api/runbooks/{runbook}/execute:
    post:
      tags:
        - Runbooks
      summary: Execute a runbook
      description: |
        Execute a runbook script. The runbook file is identified by the path parameter.
        Environment variables required by the runbook should be passed in the request body as JSON.
        
        Execution will:
        1. Validate the runbook
        2. Execute the script
        3. Append execution history to the runbook file
        4. Return execution results including stdout, stderr, and a viewer link
      operationId: executeRunbook
      security:
        - bearerAuth: []
      parameters:
        - name: runbook
          in: path
          required: true
          description: The runbook filename (e.g., SimpleRunbook.md)
          schema:
            type: string
            example: SimpleRunbook.md
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteRequest'
            example:
              env_vars:
                TEST_VAR: test_value
                ANOTHER_VAR: another_value
      responses:
        '200':
          description: Runbook executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
        '401':
          description: Unauthorized - missing or invalid authentication token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - insufficient permissions (RBAC check failed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Runbook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Execution failed (script returned non-zero exit code or error occurred)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
      x-code-samples:
        - lang: curl
          source: |
            curl -X POST "http://localhost:8083/api/runbooks/SimpleRunbook.md/execute" \
              -H "Authorization: Bearer YOUR_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"env_vars":{"TEST_VAR":"test_value"}}'

  /api/runbooks/{runbook}/required-env:
    get:
      tags:
        - Runbooks
      summary: Get required environment variables
      description: |
        Get a list of environment variables required by a runbook, including which ones are
        already available in the environment and which ones are missing.
        
        This endpoint is useful for determining which environment variables need to be
        provided when executing a runbook.
      operationId: getRequiredEnv
      security:
        - bearerAuth: []
      parameters:
        - name: runbook
          in: path
          required: true
          description: The runbook filename (e.g., SimpleRunbook.md)
          schema:
            type: string
            example: SimpleRunbook.md
      responses:
        '200':
          description: Required environment variables retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequiredEnvResponse'
        '401':
          description: Unauthorized - missing or invalid authentication token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Runbook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-code-samples:
        - lang: curl
          source: |
            curl -X GET "http://localhost:8083/api/runbooks/SimpleRunbook.md/required-env" \
              -H "Authorization: Bearer YOUR_TOKEN"

  /api/config:
    get:
      tags:
        - Config
      summary: Get configuration
      description: |
        Retrieve the current application configuration including configuration items
        and the authenticated user's token information.
        
        The response includes:
        - config_items: A list of configuration items with their values and sources
        - token: The authenticated user's token information including user_id, roles, and claims
      operationId: getConfig
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Configuration retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'
        '401':
          description: Unauthorized - missing or invalid authentication token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-code-samples:
        - lang: curl
          source: |
            curl -X GET "http://localhost:8083/api/config" \
              -H "Authorization: Bearer YOUR_TOKEN"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT Bearer token authentication. Include the token in the Authorization header as:
        `Authorization: Bearer YOUR_TOKEN_HERE`
        
        For development, use the `/dev-login` endpoint to obtain a token.
        For production, obtain tokens from your authentication provider.
  
  schemas:
    ExecuteRequest:
      type: object
      properties:
        env_vars:
          type: object
          additionalProperties:
            type: string
          description: Environment variables to set for script execution
          example:
            TEST_VAR: test_value
            ANOTHER_VAR: another_value
      description: Request body for executing a runbook

    ValidateRequest:
      type: object
      properties:
        env_vars:
          type: object
          additionalProperties:
            type: string
          description: Environment variables to use for validation
          example:
            TEST_VAR: test_value
      description: Request body for validating a runbook

    ExecuteResponse:
      type: object
      required:
        - success
        - runbook
        - return_code
      properties:
        success:
          type: boolean
          description: Whether execution completed successfully (return code 0)
          example: true
        runbook:
          type: string
          description: The runbook filename that was executed
          example: SimpleRunbook.md
        return_code:
          type: integer
          description: Exit code from script execution
          example: 0
        stdout:
          type: string
          description: Standard output from script execution
          example: "Running SimpleRunbook\nTest variable value: test_value\n"
        stderr:
          type: string
          description: Standard error from script execution
          example: ""
        errors:
          type: array
          items:
            type: string
          description: Validation or execution errors (empty if successful)
          example: []
        warnings:
          type: array
          items:
            type: string
          description: Validation warnings
          example: []
        viewer_link:
          type: string
          format: uri
          description: Link for SPA integration to view the updated runbook (format should match your SPA routing)
          example: "http://localhost:8083/runbook/SimpleRunbook.md"

    ValidateResponse:
      type: object
      required:
        - success
        - runbook
      properties:
        success:
          type: boolean
          description: Whether validation passed
          example: true
        runbook:
          type: string
          description: The runbook filename that was validated
          example: SimpleRunbook.md
        errors:
          type: array
          items:
            type: string
          description: Validation errors (empty if validation passed)
          example: []
        warnings:
          type: array
          items:
            type: string
          description: Validation warnings
          example:
            - "Runbook name 'SimpleRunbook' does not match filename 'simple-runbook'"

    RunbookContent:
      type: object
      required:
        - success
        - filename
        - name
        - content
      properties:
        success:
          type: boolean
          example: true
        filename:
          type: string
          description: The runbook filename
          example: SimpleRunbook.md
        name:
          type: string
          description: The runbook name from the first H1 header
          example: SimpleRunbook
        content:
          type: string
          description: The full markdown content of the runbook
          example: "# SimpleRunbook\n\nDescription text here.\n\n# Environment Requirements\n..."

    RunbookList:
      type: object
      required:
        - success
        - runbooks
      properties:
        success:
          type: boolean
          example: true
        runbooks:
          type: array
          items:
            $ref: '#/components/schemas/RunbookInfo'
          description: List of available runbooks

    RunbookInfo:
      type: object
      required:
        - filename
        - name
        - path
      properties:
        filename:
          type: string
          description: The runbook filename
          example: SimpleRunbook.md
        name:
          type: string
          description: The runbook name from the first H1 header
          example: SimpleRunbook
        path:
          type: string
          description: Relative path to the runbook file
          example: SimpleRunbook.md

    RequiredEnvResponse:
      type: object
      required:
        - success
        - filename
        - required
        - available
        - missing
      properties:
        success:
          type: boolean
          example: true
        filename:
          type: string
          description: The runbook filename
          example: SimpleRunbook.md
        required:
          type: array
          items:
            $ref: '#/components/schemas/EnvVarInfo'
          description: All required environment variables for this runbook
        available:
          type: array
          items:
            $ref: '#/components/schemas/EnvVarInfo'
          description: Environment variables that are already set in the environment
        missing:
          type: array
          items:
            $ref: '#/components/schemas/EnvVarInfo'
          description: Environment variables that are not set and need to be provided
      example:
        success: true
        filename: SimpleRunbook.md
        required:
          - name: TEST_VAR
            description: A test environment variable
          - name: ANOTHER_VAR
            description: Another required variable
        available:
          - name: ANOTHER_VAR
            description: Another required variable
        missing:
          - name: TEST_VAR
            description: A test environment variable

    EnvVarInfo:
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
          description: The environment variable name
          example: TEST_VAR
        description:
          type: string
          description: Description of what the variable should contain
          example: A test environment variable

    ErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error message
          example: "Runbook not found: InvalidRunbook.md"
        runbook:
          type: string
          description: The runbook filename (if applicable)
          example: InvalidRunbook.md

    ConfigResponse:
      type: object
      required:
        - config_items
        - token
      properties:
        config_items:
          type: array
          items:
            $ref: '#/components/schemas/ConfigItem'
          description: List of configuration items with their values and sources
        token:
          $ref: '#/components/schemas/TokenInfo'
          description: The authenticated user's token information
      description: Response from the /api/config endpoint

    ConfigItem:
      type: object
      required:
        - name
        - value
        - from
      properties:
        name:
          type: string
          description: The configuration variable name
          example: API_PORT
        value:
          type: string
          description: The configuration value (secrets are masked as "secret")
          example: "8083"
        from:
          type: string
          enum:
            - default
            - environment
          description: The source of the configuration value
          example: environment
      description: A single configuration item with its value and source

    TokenInfo:
      type: object
      required:
        - user_id
        - roles
        - remote_ip
        - claims
      properties:
        user_id:
          type: string
          description: The user ID from the JWT token
          example: dev-user-1
        roles:
          type: array
          items:
            type: string
          description: List of roles assigned to the user
          example:
            - developer
            - admin
        remote_ip:
          type: string
          description: The remote IP address of the client making the request
          example: "127.0.0.1"
        claims:
          type: object
          additionalProperties: true
          description: The full JWT claims object
          example:
            iss: dev-idp
            aud: dev-api
            sub: dev-user-1
            iat: 1234567890
            exp: 1234571490
            roles:
              - developer
              - admin
      description: Token information extracted from the JWT authentication token
