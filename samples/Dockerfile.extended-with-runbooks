# Stage0 runner image with Docker CLI, GitHub CLI, and packaged runbooks
# Combines Dockerfile.extended with Dockerfile.with-runbooks
# 
# Usage:
#   docker build -f Dockerfile.extended-with-runbooks -t my-runbooks:latest .
#   docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
#     -e GITHUB_TOKEN=$GITHUB_TOKEN \
#     my-runbooks:latest runbook execute --runbook /opt/stage0/runbooks/MyRunbook.md

FROM ghcr.io/agile-learning-institute/stage0_runner:latest

# Install Docker CLI and GitHub CLI
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        gnupg \
        lsb-release && \
    # Install Docker CLI
    install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    chmod a+r /etc/apt/keyrings/docker.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update && \
    apt-get install -y --no-install-recommends docker-ce-cli && \
    # Install GitHub CLI
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt-get update && \
    apt-get install -y --no-install-recommends gh && \
    # Clean up
    rm -rf /var/lib/apt/lists/*

# Create directory for runbooks
RUN mkdir -p /opt/stage0/runbooks

# Copy runbooks folder into the container
# Assumes runbooks are in ./runbooks/ relative to build context
COPY runbooks/ /opt/stage0/runbooks/

# Set working directory to runbooks location for convenience
WORKDIR /opt/stage0/runbooks

